<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1.0">
    <title>Mapbox GL JS - 3D Globe with Current Location</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.9.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.9.1/mapbox-gl.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }

        /* Button to start compass (for iOS) */
        #startBtn {
            position: absolute;
            top: 20px;  /* Adjust position */
            left: 20px; /* Adjust position */
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            z-index: 10;  /* Ensures the button is in front of the map */
            border-radius: 5px; /* Optional: rounded corners for the button */
        }

        /* Custom marker style */
        .marker {
            background-image: url('https://cdn.prod.website-files.com/62c5e0898dea0b799c5f2210/62e8212acc540f291431bad2_location-icon.png');
            background-size: cover;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <button id="startBtn">Start Compass</button>
    <div id="map"></div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1Ijoic2FiYXJpc2hzIiwiYSI6ImNtMGo0dW50aDBxcWoya29neGptOXdyYmwifQ.e20zeNypFv8y7afl414PSA';

        let userLocation = [30, 15]; // Default location (will be replaced once geolocation is available)
        let userMarker = null;
        let deviceBearing = 0; // Store the device's heading
        let lastBearing = 0;  // Store the last bearing to create smooth transition
        let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent); // Detect iOS device

        const startBtn = document.getElementById("startBtn");

        // Function to initialize the map
        function initializeMap(center) {
            const map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/sabarishs/cm5apzgaz00ql01spg1dkd9fo',
                projection: 'globe',  // This makes the map appear as a 3D globe
                zoom: 10,              // Set zoom to a global view initially
                center: center,       // Set the initial map center
                pitch: 60,            // Tilt the map for 3D effect
                bearing: 0            // Set initial rotation of the globe
            });

            map.scrollZoom.disable();

            map.on('style.load', () => {
                map.setFog({
                    range: [0.5, 3],
                    color: 'rgb(255, 255, 255)',
                    highColor: 'rgb(255, 255, 255)',
                    anchor: 'center'
                });
            });

            return map;
        }

        // Function to update user's location
        function updateLocation(map) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    userLocation = [position.coords.longitude, position.coords.latitude];

                    // Create or update the marker
                    if (!userMarker) {
                        const el = document.createElement('div');
                        el.className = 'marker';

                        userMarker = new mapboxgl.Marker(el)
                            .setLngLat(userLocation)
                            .addTo(map)
                            .togglePopup();
                    } else {
                        userMarker.setLngLat(userLocation);
                    }

                    // Update the map's location and smooth transition of bearing
                    map.flyTo({
                        center: userLocation,
                        bearing: deviceBearing,  // Use the device's heading as the bearing
                        zoom: 17.9,
                        speed: 1,  // Controls the speed of the transition
                        curve: 1.5,    // Smoother transition curve
                        easing: function (t) { return t; }
                    });

                }, function(error) {
                    alert("Error retrieving location: " + error.message);
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        // Smoothly transition the bearing
        function updateBearing(map) {
            const bearingDiff = deviceBearing - lastBearing;
            const step = bearingDiff * 0.1; // Smooth transition factor (higher = slower transition)
            lastBearing += step;

            // Update the map bearing smoothly using rotateTo
            map.rotateTo(lastBearing, {
                duration: 200, // Adjust the duration for smoothness
                easing: function (t) { return t; }
            });
        }

        // Listen for the device orientation event to get the device's heading
        function startCompass() {
            if (isIOS) {
                DeviceOrientationEvent.requestPermission()
                    .then((response) => {
                        if (response === "granted") {
                            window.addEventListener("deviceorientation", handler, true);
                        } else {
                            alert("Compass permission has to be allowed!");
                        }
                    })
                    .catch(() => alert("Device Orientation not supported"));
            } else {
                window.addEventListener("deviceorientationabsolute", handler, true);
            }
        }

        function handler(e) {
            // For iOS and Android, use the appropriate property for the heading
            deviceBearing = e.webkitCompassHeading || Math.abs(e.alpha - 360); // Normalize to compass heading
            console.log("Device bearing:", deviceBearing); // You can remove this log for production
        }

        // First, get the user's location and initialize the map
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                userLocation = [position.coords.longitude, position.coords.latitude];
                
                // Initialize the map with the user's location as the center
                const map = initializeMap(userLocation);

                // Update location and bearing every 100ms for continuous movement
                setInterval(() => {
                    updateLocation(map);
                    updateBearing(map); // Smoothly update the bearing based on device orientation
                }, 100);
            }, function(error) {
                alert("Error retrieving location: " + error.message);
            });
        } else {
            alert("Geolocation is not supported by this browser.");
        }

        // Start compass on button click
        startBtn.addEventListener("click", startCompass);

    </script>
</body>
</html>
