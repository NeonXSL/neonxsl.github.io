<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1.0">
    <title>Mapbox GL JS - 3D Globe with Current Location</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.9.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.9.1/mapbox-gl.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        /* Custom marker style */
        .marker {
            background-image: url('https://cdn.prod.website-files.com/62c5e0898dea0b799c5f2210/62e8212acc540f291431bad2_location-icon.png');
            background-size: cover;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
        }

        #startButton {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }

        #startButton:disabled {
            background-color: #ccc;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <button id="startButton">Enable Compass</button>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1Ijoic2FiYXJpc2hzIiwiYSI6ImNtMGo0dW50aDBxcWoya29neGptOXdyYmwifQ.e20zeNypFv8y7afl414PSA';

        let userLocation = [30, 15]; // Default location (will be replaced once geolocation is available)
        let userMarker = null;
        let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        let currentBearing = 0;
        let map;

        // Function to initialize the map
        function initializeMap(center) {
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/sabarishs/cm5apzgaz00ql01spg1dkd9fo',
                projection: 'globe',  // This makes the map appear as a 3D globe
                zoom: 10,              // Set zoom to a global view initially
                center: center,       // Set the initial map center
                pitch: 60,            // Tilt the map for 3D effect
                bearing: currentBearing,  // Set initial rotation of the globe
            });

            map.scrollZoom.disable();

            map.on('style.load', () => {
                map.setFog({
                    range: [0.5, 3],
                    color: 'rgb(255, 255, 255)',
                    highColor: 'rgb(255, 255, 255)',
                    anchor: 'center'
                });
            });

            return map;
        }

        // Function to update user's location
        function updateLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    userLocation = [position.coords.longitude, position.coords.latitude];

                    // Create or update the marker
                    if (!userMarker) {
                        const el = document.createElement('div');
                        el.className = 'marker';

                        userMarker = new mapboxgl.Marker(el)
                            .setLngLat(userLocation)
                            .addTo(map)
                            .togglePopup();
                    } else {
                        userMarker.setLngLat(userLocation);
                    }

                    // Smooth transition to new location
                    map.flyTo({
                        center: userLocation,
                        bearing: currentBearing,
                        zoom: 17.9,
                        speed: 1,  // Controls the speed of the transition
                        curve: 1.5,    // Smoother transition curve
                        easing: function (t) { return t; }
                    });

                }, function(error) {
                    alert("Error retrieving location: " + error.message);
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        // Function to update bearing based on device orientation
        function updateBearing(e) {
            let degree = e.webkitCompassHeading || Math.abs(e.alpha - 360);
            if (degree !== undefined) {
                currentBearing = degree;

                // Log the bearing and orientation data to the console
                console.log("Current Bearing: " + currentBearing);
                console.log("Device Orientation - Alpha: " + e.alpha + " | Beta: " + e.beta + " | Gamma: " + e.gamma);

          
            }
        }

        // Function to start the compass on iOS
        function startCompass() {
            if (isIOS) {
                DeviceOrientationEvent.requestPermission()
                    .then((response) => {
                        if (response === "granted") {
                            window.addEventListener("deviceorientation", updateBearing, true);
                        } else {
                            alert("Permission must be granted!");
                        }
                    })
                    .catch(() => alert("Device Orientation not supported"));
            } else {
                window.addEventListener("deviceorientationabsolute", updateBearing, true);
            }
        }

        // Initialize the map after getting the user's location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                userLocation = [position.coords.longitude, position.coords.latitude];
                
                // Initialize the map with the user's location as the center
                initializeMap(userLocation);

                // Update location every 5 seconds for continuous movement
                setInterval(updateLocation, 100);
                
                // Enable compass on button click (for iOS)
                document.getElementById("startButton").addEventListener("click", startCompass);

            }, function(error) {
                alert("Error retrieving location: " + error.message);
            });
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    </script>
</body>
</html>
